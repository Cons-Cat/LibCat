// -*- mode: c++ -*-
// vim: set ft=cpp:
#pragma once

// TODO: Consolidate this into `<linux>`. And a lot of this is unnecessary.

enum ProtectionFlags : unsigned int
{
    none = 0b000,     // Data cannot be accessed at all.
    read = 0b001,     // Data is readable.
    write = 0b010,    // Data is writable.
    execute = 0b100,  // Data can be executed.
};

enum MapFlags : unsigned int
{
    shared = 0b1,          // Writes change the underlying object.
    MAP_PRIVATE = 0b10,    // Writes only change the calling process.
    fixed = 0b10000,       /* Map to precisely this address, rather than virtual
                            * memory. This may fail. */
    anonymous = 0b100000,  // Not backed by a file descriptor.
    // TODO: Make binary/hexa format consistent.
    growsdown = 0x00100,   // Stack-like segment.
    denywrite = 0x00800,   // ETXTBSY.
    executable = 0x01000,  // Mark it as an executable.
    locked = 0x02000,      // Lock the mapping.
    noreserve = 0x04000,   // Don't check for reservations.
    populate = 0x08000,    // Populate (prefault) pagetables.
    nonblock = 0x10000,    // Do not block on IO.
    stack = 0x20000,       // Allocation is for a stack.
    hugetlb = 0x40000,     // Create huge page mapping.
    sync = 0x80000,        // Perform synchronous page faults for the mapping.
    fixed_noreplace =
        0x100000,  // MAP_FIXED but do not unmap underlying mapping.
};

struct Process;

// TODO: Enforce that `FileDescriptor` cannot be constructed with a negative
// value. This is an index into the kernel's file descriptor table.
struct FileDescriptor {
    int4 value;

    FileDescriptor() = default;
    FileDescriptor(int4 const input) {
        this->value = input;
    }
};

// TODO: Document these:
// TODO: Make these strongly typed.
using UserId = uint8;
using GroupId = uint8;
using ProcessId = int8;

// TODO: Less esoteric names.
enum WaitIdType
{
    all = 0,
    process_id = 1,
    process_group = 2,
    file_descriptor = 3
};

// TODO: Write comments for these, and simplifiy names.
// https://linux.die.net/man/2/clone
enum CloneFlags : unsigned int
{
    csignal = 0x000000ff,
    newtime = 0x00000080,
    vm = 0x00000100,
    fs = 0x00000200,
    files = 0x00000400,
    sighand = 0x00000800,
    clone_pidfd = 0x00001000,
    ptrace = 0x00002000,
    vfork = 0x00004000,
    parent = 0x00008000,
    thread = 0x00010000,
    newns = 0x00020000,
    sysvsem = 0x00040000,
    settls = 0x00080000,
    parent_set_tid = 0x00100000,
    child_clear_tid = 0x00200000,
    detached = 0x00400000,
    untraced = 0x00800000,
    child_set_tid = 0x01000000,
    newcgroup = 0x02000000,
    newuts = 0x04000000,
    newipc = 0x08000000,
    newuser = 0x10000000,
    newpid = 0x20000000,
    newnet = 0x40000000,
    io = 0x80000000,
};

// TODO: Remove `wait_`.
enum WaitOptions : int8
{
    no_hang = 1,
    wait_untraced = 2,
    stopped = 2,
    exited = 4,
    continued = 8,
    no_wait = 0x1000000,
    no_thread = 0x20000000,
    wait_all = 0x40000000,
    clone = 0x80000000,
};
